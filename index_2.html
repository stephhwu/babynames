<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Name Constellation with Summary</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .star {
        stroke: none;
        cursor: pointer;
        fill: white;
      }
      .line {
        stroke-width: 1px;
        opacity: 0.5;
      }
      .year-label {
        font-size: 24px;
        fill: white;
      }
      .name-label {
        font-size: 10px;
        fill: white;
      }
      .timeline,
      .summary {
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }
      .year-button {
        color: white;
        margin: 0 5px;
        cursor: pointer;
      }
      .year-button:hover {
        font-weight: bold;
        color: lightblue;
      }
      .search-box {
        margin-top: 10px;
      }
    </style>
  </head>
  <body
    style="
      background: black;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    "
  >
    <svg id="constellation" width="800" height="600"></svg>
    <div id="timeline" class="timeline"></div>
    <input
      type="text"
      id="nameSearch"
      class="search-box"
      placeholder="Search for a name..."
    />
    <div id="summary" class="summary"></div>

    <script>
      const svg = d3.select("#constellation");
      const width = 800;
      const height = 600;
      const centerX = width / 2;
      const centerY = height / 2;
      const maxRadius = Math.min(width, height) / 2 - 50;
      const yearLabel = svg
        .append("text")
        .attr("class", "year-label")
        .attr("x", width - 100)
        .attr("y", 50)
        .text("");

      // Function to count syllables (basic heuristic)
      function countSyllables(name) {
        name = name.toLowerCase();
        const syllablePattern = /[aeiouy]+/g;
        const matches = name.match(syllablePattern);
        return matches ? matches.length : 1;
      }

      d3.csv("Popular_Baby_Names_20241011.csv").then((data) => {
        data = data.slice(0, 20000);
        const nameAggregates = {};
        data.forEach((d) => {
          d.Rank = +d.Rank;
          d.Count = +d.Count;
          const name = d["Child's First Name"];
          if (!nameAggregates[name]) {
            nameAggregates[name] = {
              totalCount: 0,
              occurrences: 0,
              rankSum: 0,
            };
          }
          nameAggregates[name].totalCount += d.Count;
          nameAggregates[name].occurrences += 1;
          nameAggregates[name].rankSum += d.Rank;
        });

        const maxCount = d3.max(
          Object.values(nameAggregates),
          (d) => d.totalCount
        );
        const brightnessScale = d3
          .scaleLinear()
          .domain([0, maxCount])
          .range([0.2, 1]);
        const ethnicityColors = d3.scaleOrdinal(d3.schemeCategory10);

        data.forEach((d) => {
          d.syllables = countSyllables(d["Child's First Name"]);
          const angle = Math.random() * 2 * Math.PI;
          const radius = Math.sqrt(Math.random()) * maxRadius;
          d.x = centerX + radius * Math.cos(angle);
          d.y = centerY + radius * Math.sin(angle);
        });

        const years = [...new Set(data.map((d) => d["Year of Birth"]))];

        svg
          .selectAll(".star")
          .data(data, (d) => d["Child's First Name"])
          .join("circle")
          .attr("class", "star")
          .attr("cx", (d) => d.x)
          .attr("cy", (d) => d.y)
          .attr("r", 2)
          .attr("fill", "white")
          .attr("opacity", (d) =>
            brightnessScale(nameAggregates[d["Child's First Name"]].totalCount)
          )
          .on("mouseover", function (event, d) {
            svg
              .append("text")
              .attr("class", "name-label")
              .attr("x", d.x + 4)
              .attr("y", d.y - 4)
              .text(d["Child's First Name"]);
          })
          .on("mouseout", function () {
            svg.selectAll(".name-label").remove();
          });

        const timeline = d3.select("#timeline");
        years.forEach((year) => {
          timeline
            .append("span")
            .attr("class", "year-button")
            .text(year)
            .on("click", () => drawTopNamesForYear(year));
        });

        function drawTopNamesForYear(year) {
          svg.selectAll(".line").remove();
          svg.selectAll(".name-label").remove();

          const yearData = data
            .filter((d) => d["Year of Birth"] == year)
            .sort((a, b) => a.Rank - b.Rank)
            .slice(0, 10);
          yearLabel.text(year);
          const colorScale = d3
            .scaleSequential(d3.interpolateCool)
            .domain([1, 10]);

          svg
            .selectAll(".line")
            .data(d3.pairs(yearData))
            .join("line")
            .attr("class", "line")
            .attr("x1", (d) => d[0].x)
            .attr("y1", (d) => d[0].y)
            .attr("x2", (d) => d[1].x)
            .attr("y2", (d) => d[1].y)
            .attr("stroke", (d, i) => colorScale(i));

          svg
            .selectAll(".star")
            .attr("opacity", 0.2)
            .attr("fill", "white")
            .filter((d) => yearData.includes(d))
            .attr("opacity", 1)
            .attr("r", 4)
            .attr("fill", (d) => ethnicityColors(d.Ethnicity));

          svg
            .selectAll(".name-label")
            .data(yearData, (d) => d["Child's First Name"])
            .join("text")
            .attr("class", "name-label")
            .attr("x", (d) => d.x + 4)
            .attr("y", (d) => d.y - 4)
            .text((d) => d["Child's First Name"]);
        }

        d3.select("#nameSearch").on("input", function () {
          const searchTerm = this.value.toLowerCase();
          svg
            .selectAll(".star")
            .attr("opacity", 0.2)
            .attr("r", 2)
            .attr("fill", "white");
          const filteredData = data.filter((d) =>
            d["Child's First Name"].toLowerCase().includes(searchTerm)
          );
          svg
            .selectAll(".star")
            .data(filteredData, (d) => d["Child's First Name"])
            .attr("fill", "yellow")
            .attr("opacity", 1)
            .attr("r", 4);

          svg
            .selectAll(".name-label")
            .data(filteredData, (d) => d["Child's First Name"])
            .join("text")
            .attr("class", "name-label")
            .attr("x", (d) => d.x + 4)
            .attr("y", (d) => d.y - 4)
            .text((d) => d["Child's First Name"]);

          const summary = d3.select("#summary");
          if (filteredData.length > 0) {
            const name = filteredData[0]["Child's First Name"];
            const count = nameAggregates[name].totalCount;
            const birthYears = [
              ...new Set(filteredData.map((d) => d["Year of Birth"])),
            ];
            const ages = birthYears.map(
              (year) => new Date().getFullYear() - year
            );
            summary.text(
              `There are ${count} people named ${name}. They are approximately ${ages.join(
                ", "
              )} years old.`
            );
          } else {
            summary.text("No matching names found.");
          }
        });
      });
    </script>
  </body>
</html>
